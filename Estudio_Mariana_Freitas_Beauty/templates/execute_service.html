{% extends "base.html" %}

{% block title %}Executar Serviço - {{ config.SALON_NAME }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-check-circle"></i> Executar Serviço
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading">Detalhes do Agendamento</h6>
                    <p class="mb-0">
                        <strong>Cliente:</strong> {{ appointment.client_name }}<br>
                        <strong>Serviço:</strong> {{ appointment.service_name }}<br>
                        <strong>Data/Hora:</strong> {{ appointment.datetime.strftime('%d/%m/%Y %H:%M') }}
                    </p>
                </div>

                <form method="POST">
                    <h6 class="mb-3">Produtos Utilizados</h6>
                    
                    {% if products %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Estoque Atual</th>
                                        <th>Quantidade Utilizada</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in products %}
                                        <tr>
                                            <td>{{ product.name }}</td>
                                            <td>{{ "%.2f"|format(product.quantity) }} un</td>
                                            <td>
                                                <div class="input-group">
                                                    <input type="number" 
                                                           class="form-control product-quantity" 
                                                           name="product_{{ product.id }}"
                                                           step="0.01" 
                                                           min="0" 
                                                           max="{{ product.quantity }}"
                                                           value="0"
                                                           data-product-name="{{ product.name }}"
                                                           data-product-quantity="{{ product.quantity }}">
                                                    <span class="input-group-text">un</span>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Nenhum produto cadastrado.
                        </div>
                    {% endif %}

                    <div class="mt-4">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> Confirmar Execução
                        </button>
                        <a href="{{ url_for('appointments') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Validate product quantities
    document.querySelectorAll('.product-quantity').forEach(input => {
        input.addEventListener('input', function() {
            const quantity = parseFloat(this.value) || 0;
            const maxQuantity = parseFloat(this.dataset.productQuantity);
            
            if (quantity > maxQuantity) {
                this.setCustomValidity(`Quantidade máxima disponível: ${maxQuantity} un`);
            } else if (quantity < 0) {
                this.setCustomValidity('A quantidade não pode ser negativa');
            } else {
                this.setCustomValidity('');
            }
        });
        
        input.addEventListener('blur', function() {
            if (this.value) {
                this.value = parseFloat(this.value).toFixed(2);
            }
        });
    });
    
    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        let hasProducts = false;
        
        document.querySelectorAll('.product-quantity').forEach(input => {
            if (parseFloat(input.value) > 0) {
                hasProducts = true;
            }
        });
        
        if (!hasProducts) {
            e.preventDefault();
            alert('Selecione pelo menos um produto utilizado no serviço.');
        }
    });
</script>
{% endblock %} 